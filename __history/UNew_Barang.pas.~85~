unit UNew_Barang;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, RzButton, Vcl.ExtCtrls, Vcl.StdCtrls,
  RzCmboBx, Data.DB, MemDS, DBAccess, Uni, RzBtnEdt, Vcl.Mask, RzEdit,
  Vcl.Buttons;

type
  TFNew_Barang = class(TForm)
    EdNm: TEdit;
    EdKd: TEdit;
    Edno1: TEdit;
    Edno: TEdit;
    EdCategory: TRzComboBox;
    Label8: TLabel;
    Label3: TLabel;
    Label6: TLabel;
    Label4: TLabel;
    Label2: TLabel;
    Label5: TLabel;
    Label1: TLabel;
    Label7: TLabel;
    Panel1: TPanel;
    BBatal: TRzBitBtn;
    BSimpan: TRzBitBtn;
    BEdit: TRzBitBtn;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    EdMerk: TRzComboBox;
    Label13: TLabel;
    Label14: TLabel;
    Edjenis: TRzComboBox;
    Label19: TLabel;
    Edkd_akun: TRzEdit;
    Label20: TLabel;
    EdNm_akun: TRzButtonEdit;
    SpeedButton1: TSpeedButton;
    Cbkdtr: TComboBox;
    SpeedButton2: TSpeedButton;
    Btn_Satuan: TSpeedButton;
    EdSatuan: TRzButtonEdit;
    procedure BBatalClick(Sender: TObject);
    procedure BSimpanClick(Sender: TObject);
    procedure EdCategorySelect(Sender: TObject);
    procedure EdjenisSelect(Sender: TObject);
    procedure EdNm_akunButtonClick(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure SpeedButton2Click(Sender: TObject);
    procedure Btn_SatuanClick(Sender: TObject);
    procedure EdSatuanButtonClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    id_ct,idmaterial,no_urut,kode:string;
    status_tr:integer;
    Procedure Load;
  end;

Function FNew_Barang: TFNew_Barang;

implementation

{$R *.dfm}

uses  umainmenu, UDataModule, UAkun_Perkiraan_TerimaMat, UKategori_Barang,
  UListBarang, UNew_KategoriBarang, UItem_Type, UNew_ItemType, UCari_DaftarPerk,
  UNew_Satuan;

var RealFNew_barang: TFNew_barang;
function FNew_Barang: TFNew_Barang;
begin
  if RealFNew_barang <> nil then FNew_barang:= RealFNew_barang
  else  Application.CreateForm(TFNew_Barang, Result);
end;

Procedure TFNew_Barang.Load;
begin
  Edjenis.Clear;
  with dm.Qtemp do
  begin
    close;
    sql.Clear;
    sql.Text:='select type from t_item_type where deleted_at isnull';
    ExecSQL;
  end;
  Dm.Qtemp.First;
  while not Dm.Qtemp.Eof do
  begin
    Edjenis.Items.Add(Dm.Qtemp['type']);
    Dm.Qtemp.Next;
  end;
end;

procedure TFNew_Barang.SpeedButton1Click(Sender: TObject);
begin
  FNew_KategoriBarang.Show;
  FNew_KategoriBarang.statustr:=3;
end;

procedure TFNew_Barang.SpeedButton2Click(Sender: TObject);
begin
  FNew_ItemType.Show;
  FNew_ItemType.statustr:=3;
end;

procedure TFNew_Barang.BBatalClick(Sender: TObject);
begin
  FlistBarang.Show;
  FlistBarang.ActRoExecute(sender);
  Close;
end;

procedure TFNew_Barang.BSimpanClick(Sender: TObject);
begin
  if Edjenis.Text='' then
  begin
    MessageDlg('jenis Tidak boleh Kosong ',MtWarning,[MbOk],0);
    Edjenis.SetFocus;
    Exit;
  end;
  if EdCategory.Text='' then
  begin
    MessageDlg('Category Tidak boleh Kosong ',MtWarning,[MbOk],0);
    EdCategory.SetFocus;
    Exit;
  end;
  if EdKd.Text='' then
  begin
    MessageDlg('Kode Material Tidak boleh Kosong ',MtWarning,[MbOk],0);
    EdKd.SetFocus;
    Exit;
  end;
  if EdNm.Text='' then
  begin
    MessageDlg('Nama Material Tidak boleh Kosong ',MtWarning,[MbOk],0);
    EdNm.SetFocus;
    Exit;
  end;
  if EdSatuan.Text='' then
  begin
    MessageDlg('Satuan Tidak boleh Kosong ',MtWarning,[MbOk],0);
    EdSatuan.SetFocus;
    Exit;
  end;
   with dm.Qtemp do
  begin
    close;
    sql.clear;
    sql.Text:='Select * from t_item';
    ExecSQL;
  end;
  if not dm.koneksi.InTransaction then
  dm.koneksi.StartTransaction;
  try
    begin
      if status_tr=0 then
      begin
       with dm.Qtemp do
       begin
       close;
       sql.clear;
       sql.Text:='insert into t_item(order_no,item_code,item_name,category_id,unit,merk,account_code,created_by)'+
       ' values(:order_no,:item_cd,:item_nm,:id_ct,:unit,:merk,:akun_cd,:pic)';
         ParamByName('order_no').Value:=Edno.Text;
         ParamByName('item_cd').Value:=EdKd.Text;
         ParamByName('item_nm').Value:=EdNm.Text;
         ParamByName('id_ct').Value:=id_ct;
         ParamByName('unit').Value:=EdSatuan.Text;
         ParamByName('merk').Value:=EdMerk.Text;
         ParamByName('akun_cd').Value:=edkd_akun.text;
         ParamByName('pic').Value:=Nm;
       ExecSQL;
       end;
      end;
      if status_tr=1 then
      begin
       with dm.Qtemp do
       begin
       close;
       sql.clear;
       sql.Text:=' Update t_item set order_no=:order_no,item_code=:item_code,item_name=:item_name,'+
       ' unit=:unit,merk=:merk,account_code=:akun_code,category_id=:ct_id,updated_at=now(), '+
       ' updated_by=:pic where "id"=:id';
         ParamByName('order_no').Value:=Edno.Text;
         ParamByName('item_code').Value:=EdKd.Text;
         ParamByName('item_name').Value:=EdNm.Text;
         ParamByName('unit').Value:=EdSatuan.Text;
         ParamByName('merk').Value:=EdMerk.Text;
         ParamByName('akun_code').Value:=Edkd_akun.Text;
         ParamByName('ct_id').Value:=id_ct;
         ParamByName('id').Value:=idmaterial;
         ParamByName('pic').Value:=nm;
       ExecSQL;
       end;
      end;
      dm.koneksi.Commit;
      Messagedlg('Data Berhasil di Simpan',MtInformation,[Mbok],0);
      BBatalClick(sender);
    end
    Except
    on E :Exception do
    begin
      MessageDlg(E.Message,mtError,[MBok],0);
      dm.koneksi.Rollback;
    end;
  end;
end;

procedure TFNew_Barang.Btn_SatuanClick(Sender: TObject);
begin
  with FNew_Satuan do
  begin
    show;
    Statustr:=0;
    PnlNew.Hide;
    PnlAksi.Hide;
    pnlist.show;
  end;
end;

procedure TFNew_Barang.EdCategorySelect(Sender: TObject);
var i:integer;
begin
  with dm.Qtemp do
  begin
    close;
    sql.Clear;
    sql.Text:=' select a."id",a.category,max(cast(b.order_no as INTEGER)) kode,a.code from t_item_category a INNER join '+
    ' t_item b on a."id"=b.category_id where a.category='+QuotedStr(EdCategory.Text)+''+
    ' and b.deleted_at isnull group by a."id",a.category,a.code ';
    Execute;
  end;
  if dm.Qtemp.RecordCount=0 then
  begin
    with dm.Qtemp2 do
    begin
      close;
      sql.Clear;
      sql.Text:='Select "id",category,code,order_no from t_item_category where category='+QuotedStr(EdCategory.Text);
      ExecSQL;
    end;
  //   edkd.Text:=DM.Qtemp2['code'];
     Edno.Text:=dm.Qtemp2['order_no'];
     id_ct:=dm.Qtemp2['id'];
   //  Edit1.Text:=dm.Qtemp2['id'];
     no_urut:='00001';
     kode:=DM.Qtemp2['code'];
  end;
  //
  if dm.Qtemp.RecordCount<>0 then
    begin
     id_ct:=dm.Qtemp['id'];
     kode:=DM.Qtemp['code'];
     no_urut:=IntToStr(dm.Qtemp.FieldByName('kode').AsInteger+1);
     if length(No_urut) < 5 then
      begin
        for i := length(No_urut) to 4 do
          No_urut := '0' + No_urut;
      end;
    end;
    Edno.Text:=no_urut;
    EdKd.Text:=kode + No_urut;
end;

procedure TFNew_Barang.EdjenisSelect(Sender: TObject);
begin
EdCategory.Clear;
  with dm.Qtemp do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.* from t_item_category a inner join t_item_type b on a.type_id=b."id" where b.type='+QuotedStr(Edjenis.Text)+'order by category asc';
    ExecSQL;
  end;
  Dm.Qtemp.First;
  while not Dm.Qtemp.Eof do
  begin
    EdCategory.Items.Add(Dm.Qtemp['category']);
    Dm.Qtemp.Next;
  end;
end;

procedure TFNew_Barang.EdNm_akunButtonClick(Sender: TObject);
begin
  with FCari_DaftarPerk do
  begin
    Show;
    vpanggil:='barang';
    with QDaftar_Perk do
    begin
      close;
      sql.Clear;
      SQL.Text:='SELECT b.code,b.account_name,c.header_name FROM t_ak_account_det a'+
                ' left join t_ak_account b on a.account_code=b.code  '+
                'left join t_ak_header c on b.header_code=c.header_code';
      Execute;
    end;
  end;
end;

procedure TFNew_Barang.EdSatuanButtonClick(Sender: TObject);
begin
  with FNew_Satuan do
  begin
    show;
    PnlNew.Hide;
    PnlAksi.Hide;
    pnlist.show;
  end;
end;

procedure TFNew_Barang.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Action:=cafree;
end;

procedure TFNew_Barang.FormCreate(Sender: TObject);
begin
  RealFNew_barang:=self;
end;

procedure TFNew_Barang.FormDestroy(Sender: TObject);
begin
  RealFNew_barang:=nil;
end;

procedure TFNew_Barang.FormShow(Sender: TObject);
begin
  Load;
end;

end.
