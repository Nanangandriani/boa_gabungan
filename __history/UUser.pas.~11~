unit UUser;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, DBGridEhGrouping, ToolCtrlsEh,
  DBGridEhToolCtrls, DynVarsEh, dxSkinsCore, dxSkinBasic, dxSkinBlack,
  dxSkinBlue, dxSkinBlueprint, dxSkinCaramel, dxSkinCoffee, dxSkinDarkroom,
  dxSkinDarkSide, dxSkinDevExpressDarkStyle, dxSkinDevExpressStyle, dxSkinFoggy,
  dxSkinGlassOceans, dxSkinHighContrast, dxSkiniMaginary, dxSkinLilian,
  dxSkinLiquidSky, dxSkinLondonLiquidSky, dxSkinMcSkin, dxSkinMetropolis,
  dxSkinMetropolisDark, dxSkinMoneyTwins, dxSkinOffice2007Black,
  dxSkinOffice2007Blue, dxSkinOffice2007Green, dxSkinOffice2007Pink,
  dxSkinOffice2007Silver, dxSkinOffice2010Black, dxSkinOffice2010Blue,
  dxSkinOffice2010Silver, dxSkinOffice2013DarkGray, dxSkinOffice2013LightGray,
  dxSkinOffice2013White, dxSkinOffice2016Colorful, dxSkinOffice2016Dark,
  dxSkinOffice2019Black, dxSkinOffice2019Colorful, dxSkinOffice2019DarkGray,
  dxSkinOffice2019White, dxSkinPumpkin, dxSkinSeven, dxSkinSevenClassic,
  dxSkinSharp, dxSkinSharpPlus, dxSkinSilver, dxSkinSpringtime, dxSkinStardust,
  dxSkinSummer2008, dxSkinTheAsphaltWorld, dxSkinTheBezier,
  dxSkinsDefaultPainters, dxSkinValentine, dxSkinVisualStudio2013Blue,
  dxSkinVisualStudio2013Dark, dxSkinVisualStudio2013Light, dxSkinVS2010,
  dxSkinWhiteprint, dxSkinXmas2008Blue, cxGraphics, cxControls, cxLookAndFeels,
  cxLookAndFeelPainters, dxCore, dxRibbonSkins, dxRibbonCustomizationForm,
  dxRibbon, dxBar, cxClasses, EhLibVCL, GridsEh, DBAxisGridsEh, DBGridEh,
  System.Actions, Vcl.ActnList, Vcl.PlatformDefaultStyleActnCtrls, Vcl.ActnMan,
  MemTableDataEh, Data.DB, MemTableEh, MemDS, DBAccess, Uni, DataDriverEh;

type
  TFUser = class(TForm)
    ActMenu: TActionManager;
    ActBaru: TAction;
    ActUpdate: TAction;
    ActRO: TAction;
    ActDel: TAction;
    ActPrint: TAction;
    ActApp: TAction;
    ActReject: TAction;
    ActClose: TAction;
    DBGridUser: TDBGridEh;
    dxBarManager1: TdxBarManager;
    dxBarManager1Bar1: TdxBar;
    dxBarButton2: TdxBarButton;
    dxBarButton1: TdxBarButton;
    dxBarButton3: TdxBarButton;
    dxBarButton4: TdxBarButton;
    dxBarButton5: TdxBarButton;
    dxBarButton6: TdxBarButton;
    dxBarButton7: TdxBarButton;
    dxBarLargeNew: TdxBarLargeButton;
    dxBarUpdate: TdxBarButton;
    dxBarRefresh: TdxBarButton;
    dxBarDelete: TdxBarButton;
    dxRibbon1: TdxRibbon;
    dxRibbon1Tab1: TdxRibbonTab;
    Dsduser: TDataSetDriverEh;
    QUser: TUniQuery;
    DsUser: TDataSource;
    MemUser: TMemTableEh;
    procedure ActBaruExecute(Sender: TObject);
    procedure ActUpdateExecute(Sender: TObject);
    procedure ActROExecute(Sender: TObject);
    procedure ActDelExecute(Sender: TObject);
    procedure FormShow(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    procedure refresh;
  end;

var
  FUser: TFUser;

implementation

{$R *.dfm}

uses UNew_User, UDataModule;

procedure TFUser.refresh;
begin
   with QUser do
   begin
       close;
       sql.Clear;
       sql.Text:=' select a.*, b.dept from t_user a inner join t_dept b on a.dept_code=b.dept_code  '+
                 ' where a.deleted_at is null order by a.created_at Desc ';
       open;
   end;
   QUser.Active:=False;
   QUser.Active:=True;
   QUser.Close;
   QUser.Open;
   MemUser.Close;
   MemUser.Open;
end;

procedure TFUser.ActBaruExecute(Sender: TObject);
var nik:integer;
begin
    with FNew_User do
    begin
      Show;
      Clear;
      Status:=0;
      Caption:='New User';
      WITH DM.Qtemp DO
      BEGIN
        CLOSE;
        sql.Clear;
        sql.Text:='SELECT max("right"(code, 1)) nk from t_user';
        ExecSQL;
      END;
        nik:=StrToInt(DM.Qtemp.FieldByName('nk').Value);
        FNew_User.EdNik.Text:='0'+(IntToStr(nik+1));
    end;
end;

procedure TFUser.ActDelExecute(Sender: TObject);
begin
    if messageDlg ('Anda Yakin Akan Menghapus Data '+DBGridUser.Fields[0].AsString+' '+ '?', mtInformation,  [mbYes]+[mbNo],0) = mrYes then
    begin
      with dm.Qtemp do
      begin
        Close;
        sql.Clear;
        sql.Text:='Delete From t_user where nik='+QuotedStr(DBGridUser.Fields[0].AsString);
        Execute;
      end;
      //dxbarRefreshClick(sender);
      ActROExecute(sender);
      ShowMessage('Data Berhasil di Hapus');
    end;
end;

procedure TFUser.ActROExecute(Sender: TObject);
begin
    DBGridUser.StartLoadingStatus();
    DBGridUser.FinishLoadingStatus();
    QUser.Close;
    QUser.Open;
    MemUser.Close;
    MemUser.Open;
end;

procedure TFUser.ActUpdateExecute(Sender: TObject);
begin
    with FNew_User do
    begin
      Show;
      Clear;
      Status:=1;
      Caption:='Update User';
      EdNik.Text:=MemUser['Nik'];
      EdNama.Text:=MemUser['nama'];
      EdPass.Text:=MemUser['Password'];
      CbJabatan.Text:=MemUser['Jabatan'];
      EdDept.Text:=MemUser['dept'];
      nodept:=MemUser['iddept'];
    end;
end;

procedure TFUser.FormShow(Sender: TObject);
begin
  Refresh;
end;

end.
