unit UBarang_Stok;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, DBGridEhGrouping, ToolCtrlsEh,
  DBGridEhToolCtrls, DynVarsEh, MemTableDataEh, Data.DB, DataDriverEh,
  MemTableEh, MemDS, DBAccess, Uni, Vcl.StdCtrls, RzCmboBx, RzButton, EhLibVCL,
  GridsEh, DBAxisGridsEh, DBGridEh, Vcl.ExtCtrls, RzTabs, Vcl.Mask, RzEdit,
  cxGraphics, cxControls, cxLookAndFeels, cxLookAndFeelPainters, dxRibbonSkins,
  dxRibbonCustomizationForm, dxBar, cxClasses, dxRibbon, dxSkinsCore,
  dxSkinBlack, dxSkinBlue, dxSkinBlueprint, dxSkinCaramel, dxSkinCoffee,
  dxSkinDarkRoom, dxSkinDarkSide, dxSkinDevExpressDarkStyle,
  dxSkinDevExpressStyle, dxSkinFoggy, dxSkinGlassOceans, dxSkinHighContrast,
  dxSkiniMaginary, dxSkinLilian, dxSkinLiquidSky, dxSkinLondonLiquidSky,
  dxSkinMcSkin, dxSkinMetropolis, dxSkinMetropolisDark, dxSkinMoneyTwins,
  dxSkinOffice2007Black, dxSkinOffice2007Blue, dxSkinOffice2007Green,
  dxSkinOffice2007Pink, dxSkinOffice2007Silver, dxSkinOffice2010Black,
  dxSkinOffice2010Blue, dxSkinOffice2010Silver, dxSkinOffice2013DarkGray,
  dxSkinOffice2013LightGray, dxSkinOffice2013White, dxSkinPumpkin, dxSkinSeven,
  dxSkinSevenClassic, dxSkinSharp, dxSkinSharpPlus, dxSkinSilver,
  dxSkinSpringTime, dxSkinStardust, dxSkinSummer2008, dxSkinTheAsphaltWorld,
  dxSkinsDefaultPainters, dxSkinValentine, dxSkinVS2010, dxSkinWhiteprint,
  dxSkinXmas2008Blue, dxSkinsdxRibbonPainter, dxSkinsdxBarPainter, Vcl.Buttons,
  dxSkinBasic, dxSkinOffice2016Colorful, dxSkinOffice2016Dark,
  dxSkinOffice2019Black, dxSkinOffice2019Colorful, dxSkinOffice2019DarkGray,
  dxSkinOffice2019White, dxSkinTheBezier, dxSkinVisualStudio2013Blue,
  dxSkinVisualStudio2013Dark, dxSkinVisualStudio2013Light, dxCore;

type
  TFBarang_Stok = class(TForm)
    PGControl: TRzPageControl;
    TabBaku: TRzTabSheet;
    pnList: TPanel;
    DBGridBaku: TDBGridEh;
    DBGridEh3: TDBGridEh;
    Tabnew: TRzTabSheet;
    pninput: TPanel;
    Label1: TLabel;
    qty: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label10: TLabel;
    Label12: TLabel;
    EdKd_Material: TEdit;
    EdKd_supp: TEdit;
    EdNm_supp: TRzComboBox;
    EdSatuan: TEdit;
    Edhuruf: TEdit;
    Panel1: TPanel;
    BBatal: TRzBitBtn;
    BSimpan: TRzBitBtn;
    BEdit: TRzBitBtn;
    QKimia: TUniQuery;
    DsKimia: TDataSource;
    MemKimia: TMemTableEh;
    DsdKimia: TDataSetDriverEh;
    EdNm_Material: TRzComboBox;
    Edstok: TEdit;
    Edkd: TEdit;
    Edno: TRzComboBox;
    Label2: TLabel;
    Label9: TLabel;
    Edmerk: TEdit;
    QKimia_det: TUniQuery;
    DsKimia_det: TDataSource;
    DtBln: TRzDateTimeEdit;
    DtTh: TRzDateTimeEdit;
    dxBarManager1: TdxBarManager;
    dxRibbon1Tab1: TdxRibbonTab;
    dxRibbon1: TdxRibbon;
    dxBarMb1: TdxBar;
    dxBupdate: TdxBarButton;
    dxbarRefresh: TdxBarButton;
    dxBdelete: TdxBarButton;
    TabKimia: TRzTabSheet;
    TabKemasan: TRzTabSheet;
    Dstepung_det: TDataSource;
    Qtepung_det: TUniQuery;
    MemTepung: TMemTableEh;
    Dsdtepung: TDataSetDriverEh;
    DsTepung: TDataSource;
    Qtepung: TUniQuery;
    DBGridKimia: TDBGridEh;
    DBGridEh4: TDBGridEh;
    DBGridKemasan: TDBGridEh;
    DBGridEh6: TDBGridEh;
    Qkemasan: TUniQuery;
    DsKemasan: TDataSource;
    DsdKemasan: TDataSetDriverEh;
    Memkemasan: TMemTableEh;
    QKemasan_det: TUniQuery;
    DsKemasan_det: TDataSource;
    dxBarMb2: TdxBar;
    dxBarMB3: TdxBar;
    dxBarKimiaUpdate: TdxBarButton;
    dxBbaru: TdxBarLargeButton;
    dxBarKimiaBaru: TdxBarLargeButton;
    dxBarKimiaRefresh: TdxBarButton;
    dxBarKimiaDelete: TdxBarButton;
    BarKmsBaru: TdxBarLargeButton;
    BarKmsUpdate: TdxBarButton;
    BarKmsRefresh: TdxBarButton;
    BarKmsDelete: TdxBarButton;
    TabBahanPenolong: TRzTabSheet;
    DBGridPenolong: TDBGridEh;
    DBGridEh2: TDBGridEh;
    QPenolong: TUniQuery;
    DsPenolong: TDataSource;
    DsdPenolong: TDataSetDriverEh;
    MemPenolong: TMemTableEh;
    QPenolongdet: TUniQuery;
    DsPenolongdet: TDataSource;
    dxBarManager1Bar1: TdxBar;
    dxBarButton1: TdxBarButton;
    dxBarPenolong: TdxBarButton;
    dxBarButton3: TdxBarButton;
    dxBarLargeButton1: TdxBarLargeButton;
    TabLain2: TRzTabSheet;
    dxbarmb4: TdxBar;
    dxBarLargeButton2: TdxBarLargeButton;
    dxBarButton4: TdxBarButton;
    dxBarlain: TdxBarButton;
    dxBarButton6: TdxBarButton;
    DBGridlain2: TDBGridEh;
    DBGridEh5: TDBGridEh;
    QLain2: TUniQuery;
    DsLain2: TDataSource;
    DataSetDriverEh1: TDataSetDriverEh;
    MemLain2: TMemTableEh;
    QLain2det: TUniQuery;
    DsLain2det: TDataSource;
    Panel6: TPanel;
    CkTepung: TCheckBox;
    Panel7: TPanel;
    CkKimia: TCheckBox;
    Panel8: TPanel;
    CkKemasan: TCheckBox;
    Panel9: TPanel;
    CkPenolong: TCheckBox;
    Panel10: TPanel;
    CkLain2: TCheckBox;
    TabBarang: TRzTabSheet;
    DBGridstok: TDBGridEh;
    DBGridEh7: TDBGridEh;
    Panel2: TPanel;
    CheckBox1: TCheckBox;
    QStok_Barang: TUniQuery;
    MemStok_Barang: TMemTableEh;
    QStok_Barangdet: TUniQuery;
    DsdStok_Barang: TDataSetDriverEh;
    DsStok_Barangdet: TDataSource;
    DsStok_Barang: TDataSource;
    procedure BSimpanClick(Sender: TObject);
    procedure BBatalClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure EdnoSelect(Sender: TObject);
    procedure BBaruClick(Sender: TObject);
    procedure EdNm_suppSelect(Sender: TObject);
    procedure EdhurufChange(Sender: TObject);
    procedure dxbarRefreshClick(Sender: TObject);
    procedure dxBupdateClick(Sender: TObject);
    procedure dxBbaruClick(Sender: TObject);
    procedure TabBakuShow(Sender: TObject);
    procedure TabKemasanShow(Sender: TObject);
    procedure TabKimiaShow(Sender: TObject);
    procedure dxBarKimiaUpdateClick(Sender: TObject);
    procedure BarKmsUpdateClick(Sender: TObject);
    procedure dxBdeleteClick(Sender: TObject);
    procedure dxBarKimiaDeleteClick(Sender: TObject);
    procedure BarKmsDeleteClick(Sender: TObject);
    procedure dxBarLargeButton1Click(Sender: TObject);
    procedure dxBarButton1Click(Sender: TObject);
    procedure TabBahanPenolongShow(Sender: TObject);
    procedure dxBarPenolongClick(Sender: TObject);
    procedure dxBarlainClick(Sender: TObject);
    procedure dxBarButton3Click(Sender: TObject);
    procedure dxBarButton6Click(Sender: TObject);
    procedure TabLain2Show(Sender: TObject);
    procedure dxBarButton4Click(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure CkTepungClick(Sender: TObject);
    procedure CkKimiaClick(Sender: TObject);
    procedure CkKemasanClick(Sender: TObject);
    procedure CkPenolongClick(Sender: TObject);
    procedure CkLain2Click(Sender: TObject);
    procedure dxBarKimiaRefreshClick(Sender: TObject);
    procedure BarKmsRefreshClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    Procedure Clear;
    Procedure Refresh;
    Procedure Autonumber;
    Procedure Load;
  end;

//var
Function  FBarang_Stok: TFBarang_Stok;
var
  urut:integer;
  kode,bln,th:string;

implementation

{$R *.dfm}

uses umainmenu,UNew_Barang_Stok, UDataModule; //UNew_Materialstok,

var
  realfMatStok : TFBarang_Stok;
// implementasi function
function FBarang_Stok: TFBarang_Stok;
begin
  if realfMatStok <> nil then
    FBarang_Stok:= realfMatStok
  else
    Application.CreateForm(TFBarang_Stok, Result);
end;

procedure TFBarang_Stok.CkLain2Click(Sender: TObject);
begin
if CkLain2.Checked=True then
begin
if loksbu='' then
begin
  with QLain2det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang'; //where "Outstanding"=0';
    ExecSQL;
  end;
end;
if loksbu<>'' then
begin
  with QLain2det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where b.kd_sbu='+QuotedStr(loksbu); //where "Outstanding"=0';
    ExecSQL;
  end;
end;
end;
if CkLain2.Checked=False then
begin
if loksbu='' then
begin
  with QLain2det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where "Outstanding"<>0';
    ExecSQL;
  end;
end;
if loksbu<>'' then
begin
  with QLain2det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where "Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu);
    ExecSQL;
  end;
end;
end;
end;

procedure TFBarang_Stok.CkKemasanClick(Sender: TObject);
begin
if CkKemasan.Checked=True then
begin
if loksbu='' then
begin
  with QKemasan_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang'; //where "Outstanding"=0';
    ExecSQL;
  end;
end;
if loksbu<>'' then
begin
  with QKemasan_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where b.kd_sbu='+QuotedStr(loksbu); //where "Outstanding"=0';
    ExecSQL;
  end;
end;
end;
if CkKemasan.Checked=False then
begin
if loksbu='' then
begin
  with QKemasan_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where "Outstanding"<>0';
    ExecSQL;
  end;
end;
if loksbu<>'' then
begin
  with QKemasan_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where "Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu); //where "Outstanding"=0';
    ExecSQL;
  end;
end;
end;
end;

procedure TFBarang_Stok.CkKimiaClick(Sender: TObject);
begin
if CkKimia.Checked=True then
begin
if loksbu='' then
begin
  with QKimia_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang'; //where "Outstanding"=0';
    ExecSQL;
  end;
end;
if loksbu<>'' then
begin
  with QKimia_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where b.kd_sbu='+QuotedStr(loksbu); //where "Outstanding"=0';
    ExecSQL;
  end;
end;
end;
if CkKimia.Checked=False then
begin
if loksbu='' then
begin
  with QKimia_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where "Outstanding"<>0';
    ExecSQL;
  end;
end;
if loksbu<>'' then
begin
  with QKimia_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where "Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu);
    ExecSQL;
  end;
end;
end;
end;

procedure TFBarang_Stok.CkPenolongClick(Sender: TObject);
begin
if CkPenolong.Checked=True then
begin
if loksbu='' then
begin
  with QPenolongdet do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang'; //where "Outstanding"=0';
    ExecSQL;
  end;
end;
if loksbu<>'' then
begin
  with QPenolongdet do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where b.kd_sbu='+QuotedStr(loksbu); //where "Outstanding"=0';
    ExecSQL;
  end;
end;
end;
if CkPenolong.Checked=False then
begin
if loksbu='' then
begin
  with QPenolongdet do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where "Outstanding"<>0';
    ExecSQL;
  end;
end;
if loksbu<>'' then
begin
  with QPenolongdet do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where "Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu);
    ExecSQL;
  end;
end;

end;
end;

procedure TFBarang_Stok.CkTepungClick(Sender: TObject);
begin
if CkTepung.Checked=True then
begin
if loksbu='' then
begin
  with Qtepung_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang'; //where "Outstanding"=0';
    ExecSQL;
  end;
end;
if loksbu<>'' then
begin
  with Qtepung_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where b.kd_sbu='+QuotedStr(loksbu); //where "Outstanding"=0';
    ExecSQL;
  end;
end;
end;
if CkTepung.Checked=False then
begin
if loksbu='' then
begin
  with Qtepung_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where "Outstanding"<>0';
    ExecSQL;
  end;
end;
if loksbu<>'' then
begin
  with Qtepung_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where "Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu); //where "Outstanding"=0';
    ExecSQL;
  end;
end;
end;
end;

procedure TFBarang_Stok.Clear;
begin
  FNew_Barang_Stok.EdKd_Material.Text:='';
  FNew_Barang_Stok.EdNm_Material.Text:='';
  FNew_Barang_Stok.EdKd_supp.Text:='';
  FNew_Barang_Stok.EdNm_supp.Text:='';
  FNew_Barang_Stok.Edno.Text:='';
  FNew_Barang_Stok.Edhuruf.Text:='';
  FNew_Barang_Stok.EdKd.Text:='';
  FNew_Barang_Stok.Edstok.Text:='0';
  FNew_Barang_Stok.EdSatuan.Text:='';
  FNew_Barang_Stok.Edmerk.Text:='';
end;

procedure TFBarang_Stok.dxBarButton1Click(Sender: TObject);
begin
with FNew_Barang_Stok do
begin
  Show;
  Self.Load;
  Self.Clear;
  Caption:='Update Stok Material';
  EdNm_Material.Enabled:=false;
  EdNm_supp.Enabled:=false;
  FNew_Barang_Stok.BEdit.Visible:=True;
  FNew_Barang_Stok.BSimpan.Visible:=False;
  with MemPenolong do
  begin
    FNew_Barang_Stok.EdNm_Material.Text:=MemPenolong.FieldByName('nm_material').AsString;
    FNew_Barang_Stok.EdKd_Material.Text:=MemPenolong.FieldByName('kd_material').AsString;
    FNew_Barang_Stok.EdNm_supp.Text:=MemPenolong.FieldByName('nm_supplier').AsString;
    FNew_Barang_Stok.EdKd_supp.Text:=MemPenolong.FieldByName('kd_supplier').AsString;
    FNew_Barang_Stok.Edkd.Text:=MemPenolong.FieldByName('kd_material_stok').AsString;
    FNew_Barang_Stok.Edstok.Text:=MemPenolong.FieldByName('qty').AsString;
    FNew_Barang_Stok.EdSatuan.Text:=MemPenolong.FieldByName('satuan').AsString;
    FNew_Barang_Stok.Edmerk.Text:=MemPenolong.FieldByName('merk').AsString;
    FNew_Barang_Stok.Edno.Text:=MemPenolong.FieldByName('no_urut').AsString;
    no_material:=MemPenolong.FieldByName('no_material').AsString;
    FNew_Barang_Stok.Edcategory.Text:=MemPenolong.FieldByName('category').AsString;
  end;
end;
end;

procedure TFBarang_Stok.dxBarPenolongClick(Sender: TObject);
begin
//  refresh;
QPenolong.Close;
MemPenolong.Close;
QPenolongdet.Close;
DBGridPenolong.StartLoadingStatus();
if loksbu='' then
begin
 with QPenolong do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi, '+
    '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' FROM t_material_stok AS "a" LEFT JOIN	t_supplier AS b	ON 	a.kd_supplier = b.kd_supplier  '+
	            ' INNER JOIN t_material AS "c"	ON 	a.kd_material = c.kd_material AND		a.no_material = c.no_material  '+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN   '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok)as aa on 1=1  '+
              ' where C.category=''BAHAN PENOLONG'' Order by kd_material_stok Desc';
    open;
  end;
  MemPenolong.Open;
  with QPenolongdet do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0';
    open;
  end;
end;
if loksbu<>'' then
begin
   with QPenolong do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' from t_material_stok A Left join t_supplier B on A.kd_supplier=B.kd_supplier '+
              ' inner join t_material C on A.kd_material=C.kd_material and a.no_material=c.no_material'+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok AND '+
              ' (b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu=''''))as aa on 1=1 where C.category=''BAHAN PENOLONG'''+
              ' Order by kd_material_stok Desc ';
    open;
  end;
  MemPenolong.Open;
    with QPenolongdet do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu)+' OR b.kd_sbu=''''';
    open;
  end;
end;
DBGridPenolong.FinishLoadingStatus();
end;

procedure TFBarang_Stok.dxBarButton3Click(Sender: TObject);
begin
   if messageDlg ('Anda Yakin Akan Menghapus Data '+DBGridPenolong.Fields[0].AsString+' '+ '?', mtInformation,  [mbYes]+[mbNo],0) = mrYes
then begin
with dm.Qtemp do
begin
  Close;
  sql.Clear;
  sql.Text:='Delete From t_material_stok where kd_material_stok='+QuotedStr(DBGridPenolong.Fields[0].AsString);
  Execute;
end;
dxbarRefreshClick(sender);
ShowMessage('Data Berhasil di Hapus');
end;
end;

procedure TFBarang_Stok.dxBarButton4Click(Sender: TObject);
begin
with FNew_Barang_Stok do
begin
  Show;
  Self.Load;
  Self.Clear;
  Caption:='Update Stok Material';
  EdNm_Material.Enabled:=false;
  EdNm_supp.Enabled:=false;
  FNew_Barang_Stok.BEdit.Visible:=True;
  FNew_Barang_Stok.BSimpan.Visible:=False;
  with MemPenolong do
  begin
    FNew_Barang_Stok.EdNm_Material.Text:=MemLain2.FieldByName('nm_material').AsString;
    FNew_Barang_Stok.EdKd_Material.Text:=MemLain2.FieldByName('kd_material').AsString;
    FNew_Barang_Stok.EdNm_supp.Text:=MemLain2.FieldByName('nm_supplier').AsString;
    FNew_Barang_Stok.EdKd_supp.Text:=MemLain2.FieldByName('kd_supplier').AsString;
    FNew_Barang_Stok.Edkd.Text:=MemLain2.FieldByName('kd_material_stok').AsString;
    FNew_Barang_Stok.Edstok.Text:=MemLain2.FieldByName('qty').AsString;
    FNew_Barang_Stok.EdSatuan.Text:=MemLain2.FieldByName('satuan').AsString;
    FNew_Barang_Stok.Edmerk.Text:=MemLain2.FieldByName('merk').AsString;
    FNew_Barang_Stok.Edno.Text:=MemLain2.FieldByName('no_urut').AsString;
    no_material:=MemLain2.FieldByName('no_material').AsString;
    FNew_Barang_Stok.Edcategory.Text:=MemLain2.FieldByName('category').AsString;
  end;
end;
{if loksbu<>'' then
begin

end;
DBGridPenolong.FinishLoadingStatus();  }
end;

procedure TFBarang_Stok.dxBarlainClick(Sender: TObject);
begin
//  refresh;
QLain2.Close;
MemLain2.Close;
QLain2det.Close;
DBGridlain2.StartLoadingStatus();
if loksbu='' then
begin
  with QLain2 do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,C.jenis,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' FROM t_material_stok AS "a" LEFT JOIN	t_supplier AS b	ON 	a.kd_supplier = b.kd_supplier  '+
	            ' INNER JOIN t_material AS "c"	ON 	a.kd_material = c.kd_material AND		a.no_material = c.no_material  '+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN   '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok)as aa on 1=1  '+
              ' where C.jenis<>''PRODUKSI'''+
              ' GROUP BY b.nm_supplier,c.nm_material,c.category,C.jenis,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,aa.totalmt'+
              ' Order by kd_material_stok Desc ';
    open;
  end;
  MemLain2.Open;
  with QLain2det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a left JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu)+' OR b.kd_sbu=''''';
    open;
  end;
end;
if loksbu<>'' then
begin
  with QLain2 do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,C.jenis,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' FROM t_material_stok AS "a" LEFT JOIN	t_supplier AS b	ON 	a.kd_supplier = b.kd_supplier  '+
	            ' INNER JOIN t_material AS "c"	ON 	a.kd_material = c.kd_material AND		a.no_material = c.no_material  '+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN   '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok AND '+
              ' (b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu=''''))as aa on 1=1  '+
              ' where C.jenis<>''PRODUKSI'''+
              ' GROUP BY b.nm_supplier,c.nm_material,c.category,C.jenis,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,aa.totalmt'+
              ' Order by kd_material_stok Desc ';
    open;
  end;
  MemLain2.Open;
  with QLain2det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a left JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu)+' OR b.kd_sbu=''''';
    open;
  end;
end;
DBGridlain2.FinishLoadingStatus();
end;

procedure TFBarang_Stok.dxBarButton6Click(Sender: TObject);
begin
   if messageDlg ('Anda Yakin Akan Menghapus Data '+DBGridlain2.Fields[0].AsString+' '+ '?', mtInformation,  [mbYes]+[mbNo],0) = mrYes
then begin
with dm.Qtemp do
begin
  Close;
  sql.Clear;
  sql.Text:='Delete From t_material_stok where kd_material_stok='+QuotedStr(DBGridlain2.Fields[0].AsString);
  Execute;
end;
dxbarRefreshClick(sender);
ShowMessage('Data Berhasil di Hapus');
end;
end;

procedure TFBarang_Stok.dxBarKimiaDeleteClick(Sender: TObject);
begin
   if messageDlg ('Anda Yakin Akan Menghapus Data '+DBGridKimia.Fields[0].AsString+' '+ '?', mtInformation,  [mbYes]+[mbNo],0) = mrYes
then begin
with dm.Qtemp do
begin
  Close;
  sql.Clear;
  sql.Text:='Delete From t_material_stok where kd_material_stok='+QuotedStr(DBGridKimia.Fields[0].AsString);
  Execute;
end;
dxbarRefreshClick(sender);
ShowMessage('Data Berhasil di Hapus');
end;
end;

procedure TFBarang_Stok.dxBarKimiaRefreshClick(Sender: TObject);
begin
  QKimia.Close;
  MemKimia.close;
  QKimia_det.Close;
DBGridKimia.StartLoadingStatus();
if loksbu='' then
begin
  with QKimia do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi, '+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' FROM t_material_stok AS "a" LEFT JOIN	t_supplier AS b	ON 	a.kd_supplier = b.kd_supplier  '+
	            ' INNER JOIN t_material AS "c"	ON 	a.kd_material = c.kd_material AND		a.no_material = c.no_material  '+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN   '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok)as aa on 1=1  '+
              ' where C.category=''KIMIA'' Order by kd_material_stok Desc';
    open;
  end;
  MemKimia.Open;
  with QKimia_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0';
    open;
  end;
end;
if loksbu<>'' then
begin
  with QKimia do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' from t_material_stok A Left join t_supplier B on A.kd_supplier=B.kd_supplier '+
              ' inner join t_material C on A.kd_material=C.kd_material and a.no_material=c.no_material'+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok AND '+
              ' (b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu='' ''))as aa on 1=1 where C.category=''KIMIA'''+
              ' Order by kd_material_stok Desc ';
    open;
  end;
  MemKimia.Open;
  with QKimia_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu)+' OR b.kd_sbu=''''';
    open;
  end;
end;
DBGridKimia.FinishLoadingStatus();
end;

procedure TFBarang_Stok.dxBarKimiaUpdateClick(Sender: TObject);
begin
with FNew_Barang_Stok do
begin
  Show;
  Self.Load;
  Self.Clear;
  Caption:='Update Stok Material';
  EdNm_Material.Enabled:=false;
  EdNm_supp.Enabled:=false;
  FNew_Barang_Stok.BEdit.Visible:=True;
  FNew_Barang_Stok.BSimpan.Visible:=False;
  with MemKimia do
  begin
    FNew_Barang_Stok.EdNm_Material.Text:=MemKimia.FieldByName('nm_material').AsString;
    FNew_Barang_Stok.EdKd_Material.Text:=MemKimia.FieldByName('kd_material').AsString;
    FNew_Barang_Stok.EdNm_supp.Text:=MemKimia.FieldByName('nm_supplier').AsString;
    FNew_Barang_Stok.EdKd_supp.Text:=MemKimia.FieldByName('kd_supplier').AsString;
    FNew_Barang_Stok.Edkd.Text:=MemKimia.FieldByName('kd_material_stok').AsString;
    FNew_Barang_Stok.Edstok.Text:=MemKimia.FieldByName('qty').AsString;
    FNew_Barang_Stok.EdSatuan.Text:=MemKimia.FieldByName('satuan').AsString;
    FNew_Barang_Stok.Edmerk.Text:=MemKimia.FieldByName('merk').AsString;
    FNew_Barang_Stok.Edno.Text:=MemKimia.FieldByName('no_urut').AsString;
    no_material:=MemKimia.FieldByName('no_material').AsString;
    FNew_Barang_Stok.Edcategory.Text:=MemKimia.FieldByName('category').AsString;
  end;
end;
end;

procedure TFBarang_Stok.dxBarLargeButton1Click(Sender: TObject);
begin
with FNew_Barang_Stok do
begin
  Show;
//  Self.Load;
  Self.Clear;
  EdNm_Material.Enabled:=True;
//  FNew_Barang_Stok.EdKd_Material.SetFocus;
  BSimpan.Visible:=True;
  BEdit.Visible:=False;
  Caption:='New Stok Material';
end;
end;

procedure TFBarang_Stok.dxBbaruClick(Sender: TObject);
begin
  with FNew_Barang_Stok do
  begin
    Show;
  //  Self.Load;
    Self.Clear;
    EdNm_Material.Enabled:=True;
  //  FNew_Barang_Stok.EdKd_Material.SetFocus;
    BSimpan.Visible:=True;
    BEdit.Visible:=False;
    Caption:='New Stok Material';
  end;
end;

procedure TFBarang_Stok.dxBdeleteClick(Sender: TObject);
begin
  if messageDlg ('Anda Yakin Akan Menghapus Data '+DBGridstok.Fields[0].AsString+' '+ '?', mtInformation,  [mbYes]+[mbNo],0) = mrYes
  then begin
    with dm.Qtemp do
    begin
      Close;
      sql.Clear;
      sql.Text:='update t_item_stock set deleted_by='+QuotedStr(nm)+',deleted_at=now() where item_stock_code='+QuotedStr(DBGridstok.Fields[0].AsString);
      Execute;
    end;
    dxbarRefreshClick(sender);
    ShowMessage('Data Berhasil di Hapus');
  end;
end;

procedure TFBarang_Stok.dxbarRefreshClick(Sender: TObject);
begin
//  Refresh;
  QStok_Barang.Close;
  MemStok_Barang.close;
  QStok_Barangdet.Close;
  DBGridstok.StartLoadingStatus();
  DBGridstok.FinishLoadingStatus();
  if loksbu='' then
  begin
    with QStok_Barang do
    begin
      close;
      sql.Clear;
      sql.Text:='SELECT b.supplier_name,c.item_name,d.category,a.item_code,a.supplier_code,a.item_stock_code,a.order_no,'+
      ' a.unit,a.merk,aa.totalmt as qty from t_item_stock A Left join t_supplier B on A.supplier_code=B.supplier_code '+
      ' inner join t_item C on A.item_code=C.item_code INNER JOIN t_item_category d on c.category_id=d."id" '+
      ' LEFT JOIN LATERAL (SELECT sum(a1.qty)as totalmt FROM t_item_stock_det a1 INNER JOIN t_wh b1 on '+
      ' a1.wh_code=b1.wh_code where a1.item_stock_code=a.item_stock_code)as aa on 1=1 where deleted_at isnull '+
      ' Order by item_stock_code Desc';
      open;
    end;
    MemStok_Barang.Open;
    with QStok_Barangdet do
    begin
      close;
      sql.Clear;
      sql.Text:='SELECT sum(a1.qty)as totalmt FROM t_item_stock_det a1 INNER JOIN t_wh b1 on a1.wh_code=b1.wh_code where a1."outstanding"<>0';
      open;
    end;
  end;
  if loksbu<>'' then
  begin
  with QStok_Barang do
    begin
      close;
      sql.Text:='SELECT b.supplier_name,c.item_name,d.category,a.item_code,a.supplier_code,a.item_stock_code,a.order_no,'+
      ' a.unit,a.merk,aa.totalmt as qty from t_item_stock A Left join t_supplier B on A.supplier_code=B.supplier_code '+
      ' inner join t_item C on A.item_code=C.item_code INNER JOIN t_item_category d on c.category_id=d."id" '+
      ' LEFT JOIN LATERAL (SELECT sum(a1.qty)as totalmt FROM t_item_stock_det a1 INNER JOIN t_wh b1 on '+
      ' a1.wh_code=b1.wh_code where a1.item_stock_code=a.item_stock_code and (b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu=''''))as'+
      ' aa on 1=1 where deleted_at isnull Order by item_stock_code Desc';
      Open;
    end;
    MemStok_Barang.Open;
    with QStok_Barangdet do
    begin
      close;
      sql.Clear;
      sql.Text:='SELECT sum(a1.qty)as totalmt FROM t_item_stock_det a1 INNER JOIN t_wh b1 on a1.wh_code=b1.wh_code where a1."outstanding"<>0 and b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu=''''';
      open;
    end;
  end;
end;

procedure TFBarang_Stok.dxBupdateClick(Sender: TObject);
begin
with FNew_Barang_Stok do
begin
  Show;
  Self.Load;
  Self.Clear;
  Caption:='Update Stok Material';
  EdNm_Material.Enabled:=false;
  EdNm_supp.Enabled:=false;
  FNew_Barang_Stok.BEdit.Visible:=True;
  FNew_Barang_Stok.BSimpan.Visible:=False;
  with MemTepung do
  begin
    with FNew_Barang_Stok do
    begin
    EdNm_Material.Text:=MemTepung.FieldByName('nm_material').AsString;
    EdKd_Material.Text:=MemTepung.FieldByName('kd_material').AsString;
    EdNm_supp.Text:=MemTepung.FieldByName('nm_supplier').AsString;
    EdKd_supp.Text:=MemTepung.FieldByName('kd_supplier').AsString;
    Edkd.Text:=MemTepung.FieldByName('kd_material_stok').AsString;
    Edstok.Text:=MemTepung.FieldByName('qty').AsString;
    EdSatuan.Text:=MemTepung.FieldByName('satuan').AsString;
    Edmerk.Text:=MemTepung.FieldByName('merk').AsString;
    Edno.Text:=MemTepung.FieldByName('no_urut').AsString;
    no_material:=MemTepung.FieldByName('no_material').AsString;
    Edcategory.Text:=MemTepung.FieldByName('category').AsString;
    end;
  end;
end;
end;

Procedure TFBarang_Stok.Load;
begin
  FNew_Barang_Stok.EdNm_Material.Clear;
  with Dm.Qtemp do
  begin
    close;
    sql.Text:='select kd_material,nm_material,category,no_material from t_material Group by kd_material, '+
              ' nm_material,category,no_material order by category,no_material Asc';
    ExecSQL;
  end;
  Dm.Qtemp.First;
  while not dm.Qtemp.Eof do
  begin
  FNew_Barang_Stok.EdNm_Material1.Items.Add(Dm.Qtemp.FieldByName('no_material').AsString+' '+Dm.Qtemp.FieldByName('nm_material').AsString);
  Dm.Qtemp.Next;
  end;
  FNew_Barang_Stok.Ednm_supp.Clear;
  with Dm.Qtemp do
  begin
    close;
    sql.Text:='select * from t_supplier';
    ExecSQL;
  end;
  Dm.Qtemp.First;
  while not dm.Qtemp.Eof do
  begin
  FNew_Barang_Stok.EdNm_supp.Items.Add(Dm.Qtemp.FieldByName('nm_supplier').AsString);
  Dm.Qtemp.Next;
  end;
end;

procedure TFBarang_Stok.EdhurufChange(Sender: TObject);
begin
   Edkd.Text:=EdKd_Material.Text+Edhuruf.Text;
end;

procedure TFBarang_Stok.EdNm_suppSelect(Sender: TObject);
begin
  with Dm.Qtemp do
  begin
    close;
    sql.Text:='select * from t_supplier where nm_supplier='+QuotedStr(EdNm_supp.Text);
    ExecSQL;
  end;
  EdKd_supp.Text:=Dm.Qtemp.FieldByName('kd_supplier').AsString;
  Autonumber;
  EdnoSelect(sender);
end;

procedure TFBarang_Stok.EdnoSelect(Sender: TObject);
begin
if Edno.Text='1' then Edhuruf.Text:='A' else
if Edno.Text='2' then Edhuruf.Text:='B' else
if Edno.Text='3' then Edhuruf.Text:='C' else
if Edno.Text='4' then Edhuruf.Text:='D' else
if Edno.Text='5' then Edhuruf.Text:='E' else
if Edno.Text='6' then Edhuruf.Text:='F' else
if Edno.Text='7' then Edhuruf.Text:='G' else
if Edno.Text='8' then Edhuruf.Text:='H' else
if Edno.Text='9' then Edhuruf.Text:='I' else
if Edno.Text='10' then Edhuruf.Text:='J' else
if Edno.Text='11' then Edhuruf.Text:='K' else
if Edno.Text='12' then Edhuruf.Text:='L' else
end;

procedure TFBarang_Stok.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Action:=cafree;
end;

procedure TFBarang_Stok.FormCreate(Sender: TObject);
begin
  realfMatStok:=self;
end;

procedure TFBarang_Stok.FormDestroy(Sender: TObject);
begin
  realfMatStok:=nil;
end;

procedure TFBarang_Stok.FormShow(Sender: TObject);
begin
  DtBln.Date:=now;
  DtTh.Date:=now;
//  Self.Refresh;
  Self.Clear;
  TabBaku.TabVisible:=false;
  TabKimia.TabVisible:=false;
  TabKemasan.TabVisible:=false;
  TabBahanPenolong.TabVisible:=false;
  TabLain2.TabVisible:=false;
  TabBarang.TabVisible:=true;
end;

procedure TFBarang_Stok.Refresh;
begin
if kdsbu='' then
begin
  with Qtepung do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' FROM t_material_stok AS "a" LEFT JOIN	t_supplier AS b	ON 	a.kd_supplier = b.kd_supplier  '+
	            ' INNER JOIN t_material AS "c"	ON 	a.kd_material = c.kd_material AND		a.no_material = c.no_material  '+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN   '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok)as aa on 1=1  '+
              ' where C.category=''BAHAN BAKU'' Order by kd_material_stok Desc';
    ExecSQL;
  end;
  with Qtepung_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0';
    ExecSQL;
  end;
  with QKimia do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi, '+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' FROM t_material_stok AS "a" LEFT JOIN	t_supplier AS b	ON 	a.kd_supplier = b.kd_supplier  '+
	            ' INNER JOIN t_material AS "c"	ON 	a.kd_material = c.kd_material AND		a.no_material = c.no_material  '+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN   '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok)as aa on 1=1  '+
              ' where C.category=''KIMIA'' Order by kd_material_stok Desc';
    ExecSQL;
  end;
  with QKimia_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0';
    ExecSQL;
  end;

  with QPenolong do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi, '+
    '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' FROM t_material_stok AS "a" LEFT JOIN	t_supplier AS b	ON 	a.kd_supplier = b.kd_supplier  '+
	            ' INNER JOIN t_material AS "c"	ON 	a.kd_material = c.kd_material AND		a.no_material = c.no_material  '+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN   '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok)as aa on 1=1  '+
              ' where C.category=''BAHAN PENOLONG'' Order by kd_material_stok Desc';
    ExecSQL;
  end;
  with QPenolongdet do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0';
    ExecSQL;
  end;

  with QLain2 do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,C.jenis,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' FROM t_material_stok AS "a" LEFT JOIN	t_supplier AS b	ON 	a.kd_supplier = b.kd_supplier  '+
	            ' INNER JOIN t_material AS "c"	ON 	a.kd_material = c.kd_material AND		a.no_material = c.no_material  '+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN   '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok)as aa on 1=1  '+
              ' where C.jenis<>''PRODUKSI'' '+
              ' Group by b.nm_supplier,c.nm_material,c.category,C.jenis,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,aa.totalmt '+
              ' Order by kd_material_stok Desc' ;
    ExecSQL;
  end;
  with QLain2det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a left JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0';
    ExecSQL;
  end;
end;
if kdsbu<>'' then
begin
  with Qtepung do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' from t_material_stok A Left join t_supplier B on A.kd_supplier=B.kd_supplier '+
              ' inner join t_material C on A.kd_material=C.kd_material and a.no_material=c.no_material'+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok AND '+
              ' (b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu=''''))as aa on 1=1 where C.category=''BAHAN BAKU'''+
              ' Order by kd_material_stok Desc ';
    ExecSQL;
  end;
  with Qtepung_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu)+' OR b.kd_sbu=''''';
    ExecSQL;
  end;
  with QKimia do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' from t_material_stok A Left join t_supplier B on A.kd_supplier=B.kd_supplier '+
              ' inner join t_material C on A.kd_material=C.kd_material and a.no_material=c.no_material'+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok AND '+
              ' (b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu='' ''))as aa on 1=1 where C.category=''KIMIA'''+
              ' Order by kd_material_stok Desc ';
    ExecSQL;
  end;
  with QKimia_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu)+' OR b.kd_sbu=''''';
    ExecSQL;
  end;
  with Qkemasan do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' from t_material_stok A Left join t_supplier B on A.kd_supplier=B.kd_supplier '+
              ' inner join t_material C on A.kd_material=C.kd_material and a.no_material=c.no_material'+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok AND '+
              ' (b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu='' ''))as aa on 1=1 where C.category=''BAHAN KEMASAN'''+
              ' Order by kd_material_stok Desc ';
    ExecSQL;
  end;
  with QKemasan_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu)+' OR b.kd_sbu=''''';
    ExecSQL;
  end;
    with QPenolong do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' from t_material_stok A Left join t_supplier B on A.kd_supplier=B.kd_supplier '+
              ' inner join t_material C on A.kd_material=C.kd_material and a.no_material=c.no_material'+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok AND '+
              ' (b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu=''''))as aa on 1=1 where C.category=''BAHAN PENOLONG'''+
              ' Order by kd_material_stok Desc ';
    ExecSQL;
  end;
    with QPenolongdet do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu)+' OR b.kd_sbu=''''';
    ExecSQL;
  end;
  with QLain2 do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,C.jenis,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' FROM t_material_stok AS "a" LEFT JOIN	t_supplier AS b	ON 	a.kd_supplier = b.kd_supplier  '+
	            ' INNER JOIN t_material AS "c"	ON 	a.kd_material = c.kd_material AND		a.no_material = c.no_material  '+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN   '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok AND '+
              ' (b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu=''''))as aa on 1=1  '+
              ' where C.jenis<>''PRODUKSI'''+
              ' GROUP BY b.nm_supplier,c.nm_material,c.category,C.jenis,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,aa.totalmt'+
              ' Order by kd_material_stok Desc ';
    ExecSQL;
  end;
  with QLain2det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a left JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu)+' OR b.kd_sbu=''''';
    ExecSQL;
  end;
end;
  QKimia.Close;
  MemKimia.Close;
  QKimia_det.Close;
  Qtepung.Close;
  MemTepung.Close;
  Qtepung_det.Close;
  Qkemasan.Close;
  Memkemasan.Close;
  QKemasan_det.Close;
  QPenolong.Close;
  MemPenolong.Close;
  QPenolongdet.Close;
  QLain2.Close;
  MemLain2.Close;
  QLain2det.Close;
  if QPenolong.Active=false then QPenolong.Active:=true;
  if MemPenolong.Active=false then MemPenolong.Active:=true;
  if QPenolongdet.Active=false then QPenolongdet.Active:=true;
  if QKimia.Active=false then QKimia.Active:=true;
  if MemKimia.Active=false then MemKimia.Active:=true;
  if QKimia_det.Active=false then QKimia_det.Active:=true;
  if Qtepung.Active=false then Qtepung.Active:=true;
  if MemTepung.Active=false then MemTepung.Active:=true;
  if Qtepung_det.Active=false then Qtepung_det.Active:=true;
  if Qkemasan.Active=false then Qkemasan.Active:=true;
  if Memkemasan.Active=false then Memkemasan.Active:=true;
  if QKemasan_det.Active=false then QKemasan_det.Active:=true;
  if QLain2.Active=false then QLain2.Active:=true;
  if MemLain2.Active=false then MemLain2.Active:=true;
  if QLain2det.Active=false then QLain2det.Active:=true;
end;

procedure TFBarang_Stok.TabBahanPenolongShow(Sender: TObject);
begin
  dxBarMb1.Visible:=False;
  dxBarMb2.Visible:=False;
  dxBarMb3.Visible:=False;
  dxbarmb4.Visible:=False;
  dxBarManager1Bar1.Visible:=True;
end;

procedure TFBarang_Stok.TabBakuShow(Sender: TObject);
begin
  dxBarMb1.Visible:=true;
  dxBarMb2.Visible:=False;
  dxBarMb3.Visible:=False;
  dxbarmb4.Visible:=False;
  dxBarManager1Bar1.Visible:=False;
end;

procedure TFBarang_Stok.TabKemasanShow(Sender: TObject);
begin
  dxBarMb1.Visible:=False;
  dxBarMb2.Visible:=False;
  dxBarMb3.Visible:=True;
  dxbarmb4.Visible:=False;
  dxBarManager1Bar1.Visible:=False;
end;

procedure TFBarang_Stok.TabKimiaShow(Sender: TObject);
begin
  dxBarMb1.Visible:=False;
  dxBarMb2.Visible:=True;
  dxBarMb3.Visible:=False;
  dxbarmb4.Visible:=False;
  dxBarManager1Bar1.Visible:=False;
end;

procedure TFBarang_Stok.TabLain2Show(Sender: TObject);
begin
  dxBarMb1.Visible:=False;
  dxBarMb2.Visible:=False;
  dxBarMb3.Visible:=False;
  dxbarmb4.Visible:=True;
  dxBarManager1Bar1.Visible:=False;
end;

procedure TFBarang_Stok.Autonumber;
begin
bln:=DtBln.text;
th:=DtTh.Text;
with dm.Qtemp do
begin
  Close;
  SQL.clear;
  sql.Text:=' SELECT * FROM t_item_stock Where item_code='+QuotedStr(FNew_Barang_Stok.EdKd_Material.Text);
  ExecSQL;
end;
if dm.Qtemp.RecordCount =0 then urut:=1 else
if dm.Qtemp.RecordCount >0 then
begin
with dm.Qtemp do
  begin
  close;
  sql.Clear;
  sql.Text:=' SELECT max(order_no)AS urut FROM t_item_stock Where item_code='+QuotedStr(FNew_Barang_Stok.EdKd_Material.Text);
  execsql;
  end;
    urut:=Dm.Qtemp.FieldByName('urut').AsInteger+1;
end;
   kode:=FloatToStr(urut);
//   kode:=Copy('000'+kode,length('000'+kode)-2,3);
   FNew_Barang_Stok.Edno.Text:=kode;
end;

procedure TFBarang_Stok.BarKmsDeleteClick(Sender: TObject);
begin
   if messageDlg ('Anda Yakin Akan Menghapus Data '+DBGridKemasan.Fields[0].AsString+' '+ '?', mtInformation,  [mbYes]+[mbNo],0) = mrYes
then begin
with dm.Qtemp do
begin
  Close;
  sql.Clear;
  sql.Text:='Delete From t_item_stock where item_stock_code='+QuotedStr(DBGridKemasan.Fields[0].AsString);
  Execute;
end;
dxbarRefreshClick(sender);
ShowMessage('Data Berhasil di Hapus');
end;
end;

procedure TFBarang_Stok.BarKmsRefreshClick(Sender: TObject);
begin
  Qkemasan.Close;
  Memkemasan.close;
  QKemasan_det.Close;
DBGridKemasan.StartLoadingStatus();
if loksbu='' then
begin
  with Qkemasan do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi, '+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' FROM t_material_stok AS "a" LEFT JOIN	t_supplier AS b	ON 	a.kd_supplier = b.kd_supplier  '+
	            ' INNER JOIN t_material AS "c"	ON 	a.kd_material = c.kd_material AND		a.no_material = c.no_material  '+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN   '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok)as aa on 1=1  '+
              ' where C.category=''BAHAN KEMASAN'' Order by kd_material_stok Desc';
    OPEN;
  end;
  Memkemasan.Open;
  with QKemasan_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0';
    open;
  end;
end;
if loksbu<>'' then
begin
  with Qkemasan do
  begin
    close;
    sql.Clear;
    sql.Text:='SELECT b.nm_supplier,c.nm_material,c.category,a.kd_material,a.kd_supplier,a.kd_material_stok,a.no_urut,a.kd_urut,a.satuan,a.merk,a.nm_material,a.qtyperkonversi,a.no_material,a.qtykonversi,a.satuankonversi,'+
              '(case when aa.totalmt ISNULL then 0 else aa.totalmt end) as qty  '+
              ' from t_material_stok A Left join t_supplier B on A.kd_supplier=B.kd_supplier '+
              ' inner join t_material C on A.kd_material=C.kd_material and a.no_material=c.no_material'+
              ' LEFT JOIN LATERAL (SELECT sum(a1."Outstanding")as totalmt FROM t_material_stok_det a1 INNER JOIN '+
              ' t_gudang b1 on a1.gudang=b1.nm_gudang where a1.kd_material_stok=a.kd_material_stok AND '+
              ' (b1.kd_sbu='+QuotedStr(loksbu)+' OR b1.kd_sbu='' ''))as aa on 1=1 where C.category=''BAHAN KEMASAN'''+
              ' Order by kd_material_stok Desc ';
    OPEN;
  end;
  Memkemasan.Open;
  with QKemasan_det do
  begin
    close;
    sql.Clear;
    sql.Text:='select a.*,b.kd_sbu from t_material_stok_det a INNER JOIN t_gudang b on a.gudang=b.nm_gudang where a."Outstanding"<>0 and b.kd_sbu='+QuotedStr(loksbu)+' OR b.kd_sbu=''''';
    open;
  end;
end;
DBGridKemasan.FinishLoadingStatus();
end;

procedure TFBarang_Stok.BarKmsUpdateClick(Sender: TObject);
begin
with FNew_Barang_Stok do
begin
  Show;
  Self.Load;
  Self.Clear;
  Caption:='Update Stok Material';
  EdNm_Material.Enabled:=false;
  EdNm_supp.Enabled:=false;
  FNew_Barang_Stok.BEdit.Visible:=True;
  FNew_Barang_Stok.BSimpan.Visible:=False;
  with Memkemasan do
  begin
    FNew_Barang_Stok.EdNm_Material.Text:=Memkemasan.FieldByName('nm_material').AsString;
    FNew_Barang_Stok.EdKd_Material.Text:=Memkemasan.FieldByName('kd_material').AsString;
    FNew_Barang_Stok.EdNm_supp.Text:=Memkemasan.FieldByName('nm_supplier').AsString;
    FNew_Barang_Stok.EdKd_supp.Text:=Memkemasan.FieldByName('kd_supplier').AsString;
    FNew_Barang_Stok.Edkd.Text:=Memkemasan.FieldByName('kd_material_stok').AsString;
    FNew_Barang_Stok.Edstok.Text:=Memkemasan.FieldByName('qty').AsString;
    FNew_Barang_Stok.EdSatuan.Text:=Memkemasan.FieldByName('satuan').AsString;
    FNew_Barang_Stok.Edmerk.Text:=Memkemasan.FieldByName('merk').AsString;
    FNew_Barang_Stok.Edno.Text:=Memkemasan.FieldByName('no_urut').AsString;
    no_material:=Memkemasan.FieldByName('no_material').AsString;
    FNew_Barang_Stok.Edcategory.Text:=Memkemasan.FieldByName('category').AsString;
  end;
end;
end;

procedure TFBarang_Stok.BBaruClick(Sender: TObject);
begin
{Tabnew.TabVisible:=true;
PGControl.ActivePage:=Tabnew;
Self.Load;  }
end;

procedure TFBarang_Stok.BBatalClick(Sender: TObject);
begin
Self.Clear;
Self.Refresh;
TabBaku.TabVisible:=true;
PGControl.ActivePage:=TabBaku;
end;

procedure TFBarang_Stok.BSimpanClick(Sender: TObject);
begin
 with dm.Qtemp do
begin
  close;
  sql.clear;
  sql.Text:='Select * from t_material_stok';
  ExecSQL;
end;
 with dm.Qtemp do
begin
  close;
  sql.clear;
  sql.Text:='insert into t_material_stok(kd_material_stok, kd_material,kd_supplier, qty, satuan, no_urut, merk, kd_urut)'+
            ' values('+QuotedStr(Edkd.Text)+', '+quotedstr(EdKd_Material.Text)+', '+QuotedStr(EdKd_supp.Text)+' '+
            ', '+QuotedStr(Edstok.Text)+', '+QuotedStr(EdSatuan.Text)+', '+QuotedStr(EdNo.Text)+', '+QuotedStr(Edmerk.Text)+', '+QuotedStr(Edhuruf.Text)+')';
  ExecSQL;
  end;
  ShowMessage('Data Berhasil di Simpan');
  BBatalClick(sender);
end;

end.


