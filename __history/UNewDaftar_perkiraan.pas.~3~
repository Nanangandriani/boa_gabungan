unit UNewDaftar_perkiraan;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, RzButton, Vcl.ExtCtrls, Vcl.StdCtrls,
  RzCmboBx, Data.DB, MemDS, DBAccess, Uni, DBGridEhGrouping, ToolCtrlsEh,
  DBGridEhToolCtrls, DynVarsEh, MemTableDataEh, MemTableEh, EhLibVCL, GridsEh,
  DBAxisGridsEh, DBGridEh, RzPanel;

type
  TFNewdaftar_perkiraan_bank = class(TForm)
    Panel2: TPanel;
    BBatal: TRzBitBtn;
    BSave: TRzBitBtn;
    RzPanel1: TRzPanel;
    Label16: TLabel;
    Label5: TLabel;
    Label7: TLabel;
    edkode: TEdit;
    ednama_perkiraan: TEdit;
    CBheader: TRzComboBox;
    RzBitBtn1: TRzBitBtn;
    CBposting: TRzComboBox;
    RzBitBtn3: TRzBitBtn;
    Qtemp: TUniQuery;
    RzPanel2: TRzPanel;
    RzBitBtn4: TRzBitBtn;
    DataSource1: TDataSource;
    MemTableEh1: TMemTableEh;
    DBGridnewspmuat: TDBGridEh;
    DBGridbrowse: TDBGridEh;
    Label1: TLabel;
    CBposisi_d_k: TRzComboBox;
    Label3: TLabel;
    CBkelompok_akun: TRzComboBox;
    Label9: TLabel;
    CBjenis_akun: TRzComboBox;
    Label11: TLabel;
    CBkategori: TRzComboBox;
    Qtemp2: TUniQuery;
    Qtemp3: TUniQuery;
    Label13: TLabel;
    Label18: TLabel;
    Label19: TLabel;
    CkNeraca: TCheckBox;
    procedure BBatalClick(Sender: TObject);
    procedure BSaveClick(Sender: TObject);
    procedure edkodeKeyPress(Sender: TObject; var Key: Char);
    procedure cbmodulKeyPress(Sender: TObject; var Key: Char);
    procedure RzBitBtn1Click(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure RzBitBtn2Click(Sender: TObject);
    procedure RzBitBtn3Click(Sender: TObject);
    procedure CBjenis_akunChange(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure CkNeracaClick(Sender: TObject);
    procedure CBkelompok_akunChange(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    statusnl,Kelompok:string;
    procedure Clear;
    procedure Save;
    procedure Update;
  end;

function FNewdaftar_perkiraan_bank: TFNewdaftar_perkiraan_bank;
var  Status :integer;

implementation

{$R *.dfm}

uses Udaftar_perkiraan, UNew_HeaderPerkiraan, UNewPosting,
  Ubrowse_modul;
var
//  FPakai_BahanPersbu: TFPakai_BahanPersbu;
  RealFNew_PerkBank: TFNewdaftar_perkiraan_bank;

function FNewdaftar_perkiraan_bank: TFNewdaftar_perkiraan_bank;
begin
  if RealFNew_PerkBank <> nil then
    FNewdaftar_perkiraan_bank:= RealFNew_PerkBank
  else
    Application.CreateForm(TFNewdaftar_perkiraan_bank, Result);
end;

procedure TFNewdaftar_perkiraan_bank.BBatalClick(Sender: TObject);
begin
  Clear;
  Close;
end;

procedure TFNewdaftar_perkiraan_bank.BSaveClick(Sender: TObject);
begin
  if not dm.Koneksi.InTransaction then
  dm.Koneksi.StartTransaction;
  try
  if edkode.Text='' then
  begin
    MessageDlg('Kode Wajib Diisi..!!',mtInformation,[mbRetry],0);
  end
  else if ednama_perkiraan.Text='' then
  begin
    MessageDlg('Nama Perkiraan Wajib Diisi..!!',mtInformation,[mbRetry],0);
  end
  else if Status = 0 then
  begin
    Save;
    Dm.Koneksi.Commit;
  end
  else if Status = 1 then
  begin
    Update;
    Dm.Koneksi.Commit;
  end;
  Except on E :Exception do
    begin
      begin
        MessageDlg(E.ClassName +' : '+E.Message, MtError,[mbok],0);
        Dm.koneksi.Rollback ;
      end;
    end;
  end;
end;

procedure TFNewdaftar_perkiraan_bank.CBjenis_akunChange(Sender: TObject);
begin
  CBkategori.Clear;
  with Qtemp2 do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select a.nm_kategori from t_kategori_akun a '+
              'left join t_jenis_akun b on a.id_jenis=b.id '+
              'where b.jenis_akun='+QuotedStr(CBjenis_akun.Text);
    Open;
  end;
  while not Qtemp2.Eof do
  begin
    CBkategori.Items.Add(Qtemp2.FieldByName('nm_kategori').AsString);
    Qtemp2.Next;
  end;
end;

procedure TFNewdaftar_perkiraan_bank.CBkelompok_akunChange(Sender: TObject);
begin
 if CBkelompok_akun.Text='NERACA' then Kelompok:='1' else Kelompok:='2';
end;

procedure TFNewdaftar_perkiraan_bank.cbmodulKeyPress(Sender: TObject;
  var Key: Char);
begin
  if key = chr(13) then
  begin
    BSaveClick(sender);
  end;
end;

procedure TFNewdaftar_perkiraan_bank.CkNeracaClick(Sender: TObject);
begin
  if CkNeraca.Checked=true then statusnl:='1' else statusnl:='0';
end;

procedure TFNewdaftar_perkiraan_bank.Clear;
begin
  edkode.Text:='';
  ednama_perkiraan.Text:='';
  CBjenis_akun.Clear;
  CBkategori.Clear;
  MemTableEh1.EmptyTable;
end;

procedure TFNewdaftar_perkiraan_bank.edkodeKeyPress(Sender: TObject;
  var Key: Char);
begin
  if key = chr(13) then
  begin
   ednama_perkiraan.SetFocus;
  end;
end;

procedure TFNewdaftar_perkiraan_bank.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  Action:=cafree;
end;

procedure TFNewdaftar_perkiraan_bank.FormCreate(Sender: TObject);
begin
  RealFNew_PerkBank:=Self;
end;

procedure TFNewdaftar_perkiraan_bank.FormDestroy(Sender: TObject);
begin
  RealFNew_PerkBank:=nil;
end;

procedure TFNewdaftar_perkiraan_bank.FormShow(Sender: TObject);
begin
  with dm.Qtemp do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select nama_header from t_header_perkiraan';
    Open;
  end;
  while not DM.Qtemp.Eof do
  begin
    CBheader.Items.Add(DM.Qtemp.FieldByName('nama_header').AsString);
    DM.Qtemp.Next;
  end;

  with dm.Qtemp3 do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select nama_posting from t_posting';
    Open;
  end;
  while not DM.Qtemp3.Eof do
  begin
    CBposting.Items.Add(DM.Qtemp3.FieldByName('nama_posting').AsString);
    DM.Qtemp3.Next;
  end;

  with dm.Qtemp2 do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select jenis_akun from t_jenis_akun';
    Open;
  end;
  while not DM.Qtemp2.Eof do
  begin
    CBjenis_akun.Items.Add(DM.Qtemp2.FieldByName('jenis_akun').AsString);
    DM.Qtemp2.Next;
  end;
 { with dm.Qtemp do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select * from t_kategori_akun ';
    Open;
  end;
  while not DM.Qtemp.Eof do
  begin
    CBkategori.Items.Add(DM.Qtemp.FieldByName('nm_kategori').AsString);
    DM.Qtemp.Next;
  end;   }
end;

procedure TFNewdaftar_perkiraan_bank.RzBitBtn1Click(Sender: TObject);
begin
  FNewHeaderPerkiraan.edkode_header.Text:='';
  FNewHeaderPerkiraan.ednama_header.Text:='';
  FNewHeaderPerkiraan.Show;
end;

procedure TFNewdaftar_perkiraan_bank.RzBitBtn2Click(Sender: TObject);
begin
  Fbrowse_data_modul.Show;
end;

procedure TFNewdaftar_perkiraan_bank.RzBitBtn3Click(Sender: TObject);
begin
  FNewPosting.ednama_posting.Text:='';
  FNewPosting.Show;
end;

procedure TFNewdaftar_perkiraan_bank.Save;
begin
  with dm.QTemp2 do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select kode_header from t_header_perkiraan where nama_header='+QuotedStr(CBheader.Text);
    Open;
  end;
  with QTemp do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select id from t_posting where nama_posting='+QuotedStr(cbposting.Text);
    Open;
  end;
  with QTemp2 do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select id from t_jenis_akun where jenis_akun='+QuotedStr(CBjenis_akun.Text);
    Open;
  end;
  with QTemp3 do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select kode_kategori from t_kategori_akun where nm_kategori='+QuotedStr(CBkategori.Text);
    Open;
  end;

  MemTableEh1.First;
  while not MemTableEh1.Eof do
  begin
    with dm.Qtemp do
    begin
      close;
      sql.Clear;
      sql.Text:='Insert Into t_daftar_perkiraan_detail(kode_perkiraan,id_modul) '+
                'Values (:parkode_perkiraan,:parid_modul)';
      parambyname('parkode_perkiraan').Value:=edkode.Text;
      parambyname('parid_modul').Value:=MemTableEh1['id'];
      execsql;
    end;
    MemTableEh1.Next;
  end;

  with dm.Qtemp do
  begin
    close;
    sql.Clear;
    sql.Text:='Insert Into t_daftar_perkiraan(kode,kode_header,nama_perkiraan,'+
              'posting,posisi_dk,kelompok_akun,id_jenis_akun,kd_kategori_akun,status_neraca) '+
              'Values (:parkode,:parkode_header,:parnama_perkiraan,:parposting,'+
              ':parposisi_dk,:parkelompok_akun,:parid_jenis_akun,:parkd_kategori_akun,:parstatus_neraca)';
    parambyname('parkode').Value:=edkode.Text;
    parambyname('parkode_header').Value:=dm.QTemp2.FieldByName('kode_header').AsString;
    parambyname('parnama_perkiraan').Value:=ednama_perkiraan.Text;
    parambyname('parposting').Value:=QTemp.FieldByName('id').AsString;
    ParamByName('parstatus_neraca').Value:=statusnl;
    if CBposisi_d_k.Text='Debit' then
    begin
     parambyname('parposisi_dk').Value:='D';
    end
    else
    begin
      parambyname('parposisi_dk').Value:='K';
    end;

    if CBkelompok_akun.Text='NERACA' then
    begin
      parambyname('parkelompok_akun').Value:='1';
    end
    else
    begin
      parambyname('parkelompok_akun').Value:='2';
    end;
    parambyname('parid_jenis_akun').Value:=QTemp2.FieldByName('id').AsString;
    parambyname('parkd_kategori_akun').Value:=QTemp3.FieldByName('kode_kategori').AsString;

    execsql;
  end;
  MessageDlg('Simpan Berhasil..!!',mtInformation,[MBOK],0);
  Clear;
  Close;
  FList_daftar_perkiraan.Refresh;
end;

procedure TFNewdaftar_perkiraan_bank.Update;
begin
  with dm.QTemp2 do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select kode_header from t_header_perkiraan where nama_header='+QuotedStr(CBheader.Text);
    Open;
  end;
  with QTemp do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select id from t_posting where nama_posting='+QuotedStr(cbposting.Text);
    Open;
  end;
  with QTemp2 do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select id from t_jenis_akun where jenis_akun='+QuotedStr(CBjenis_akun.Text);
    Open;
  end;
  with dm.QTemp3 do
  begin
    Close;
    Sql.Clear;
    Sql.Text:='select kode_kategori from t_kategori_akun where nm_kategori='+QuotedStr(CBkategori.Text);
    Open;
  end;

  with Dm.Qtemp do
  begin
    close;
    sql.Clear;
    Sql.Text:='Delete From t_daftar_perkiraan_detail '+
              'where kode_perkiraan='+QuotedStr(edkode.Text);
    Execsql;
  end;

  MemTableEh1.First;
  while not MemTableEh1.Eof do
  begin
    with dm.Qtemp do
    begin
      close;
      sql.Clear;
      sql.Text:='Insert Into t_daftar_perkiraan_detail(kode_perkiraan,id_modul) '+
                'Values (:parkode_perkiraan,:parid_modul)';
      parambyname('parkode_perkiraan').Value:=edkode.Text;
      parambyname('parid_modul').Value:=MemTableEh1['id'];
      execsql;
    end;
    MemTableEh1.Next;
  end;

  with Dm.Qtemp do
  begin
    close;
    Sql.Clear;
    Sql.Text :='update t_daftar_perkiraan set kode_header=:parkode_header,'+
               'nama_perkiraan=:parnama_perkiraan,posting=:parposting,'+
               'posisi_dk=:parposisi_dk,kelompok_akun=:parkelompok_akun,'+
               'id_jenis_akun=:parid_jenis_akun,kd_kategori_akun=:parkd_kategori_akun '+
               ',status_neraca=:parstatus_neraca where kode=:parkode';
    parambyname('parkode').Value:=edkode.Text;
    parambyname('parkode_header').Value:=dm.QTemp2.FieldByName('kode_header').AsString;
    parambyname('parnama_perkiraan').Value:=ednama_perkiraan.Text;
    parambyname('parposting').Value:=QTemp.FieldByName('id').AsString;
    ParamByName('parstatus_neraca').Value:=statusnl;
    if CBposisi_d_k.Text='DEBIT' then
    begin
     parambyname('parposisi_dk').Value:='D';
    end
    else
    begin
      parambyname('parposisi_dk').Value:='K';
    end;

    if CBkelompok_akun.Text='NERACA' then
    begin
      parambyname('parkelompok_akun').Value:='1';
    end
    else
    begin
      parambyname('parkelompok_akun').Value:='2';
    end;
    parambyname('parid_jenis_akun').Value:=QTemp2.FieldByName('id').AsString;
    parambyname('parkd_kategori_akun').Value:=dm.QTemp3.FieldByName('kode_kategori').AsString;
    ExecSql;
  end;
  MessageDlg('Ubah Berhasil..!!',mtInformation,[MBOK],0);
  Clear;
  Close;
  FList_daftar_perkiraan.Refresh;
end;

end.
