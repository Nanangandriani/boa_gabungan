unit UNew_User;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, RzButton, Vcl.ExtCtrls;

type
  TFNew_User = class(TForm)
    EdNama: TEdit;
    EdDept: TComboBox;
    Panel2: TPanel;
    BBatal: TRzBitBtn;
    BSimpan: TRzBitBtn;
    CbJabatan: TComboBox;
    EdPass: TEdit;
    EdNik: TEdit;
    Label10: TLabel;
    Label9: TLabel;
    Label8: TLabel;
    Label7: TLabel;
    Label6: TLabel;
    Label5: TLabel;
    Label4: TLabel;
    Label3: TLabel;
    Label2: TLabel;
    Label1: TLabel;
    kddept: TEdit;
    Kdjab: TEdit;
    Edfull_name: TEdit;
    Label11: TLabel;
    Label12: TLabel;
    procedure BBatalClick(Sender: TObject);
    procedure BSimpanClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure EdDeptSelect(Sender: TObject);
    procedure CbJabatanSelect(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    Procedure Clear;
    Procedure Load;
  end;

var
  FNew_User: TFNew_User;
  Status:integer;
  nodept:string;

implementation

{$R *.dfm}

uses UDataModule, UUser;


procedure TFNew_User.BBatalClick(Sender: TObject);
begin
   Close;
   //FUser.dxbarRefreshClick(sender);
   FUser.ActROExecute(sender);
end;

procedure TFNew_User.BSimpanClick(Sender: TObject);
begin
    if EdNik.Text='' then
    begin
      MessageDlg('NIK Tidak boleh Kosong ',MtWarning,[MbOk],0);
      EdNik.SetFocus;
      Exit;
    end;
    if EdNama.Text='' then
    begin
      MessageDlg('Nama User Tidak boleh Kosong ',MtWarning,[MbOk],0);
      EdNama.SetFocus;
      Exit;
    end;
    if EdPass.Text='' then
    begin
      MessageDlg('Password Tidak boleh Kosong ',MtWarning,[MbOk],0);
      EdPass.SetFocus;
      Exit;
    end;
    if CbJabatan.Text='' then
    begin
      MessageDlg('Jabatan Tidak boleh Kosong ',MtWarning,[MbOk],0);
      CbJabatan.SetFocus;
      Exit;
    end;
    if not dm.koneksi.InTransaction then
    dm.koneksi.StartTransaction;
    try
    begin
    if status=0 then
    begin
      with dm.Qtemp do
      begin
        close;
        sql.Clear;
        sql.Text:='insert into t_user(code,user_name,full_name,password,dept_code,position_code)values('+QuotedStr(EdNik.Text)+','+
                  ''+QuotedStr(EdNama.Text)+','+QuotedStr(Edfull_name.Text)+','+
                  ''+QuotedStr(EdPass.Text)+','+
                  ''+QuotedStr(kddept.Text)+','+
                  ''+QuotedStr(kdJab.Text)+' )';
        ExecSQL;
      end;
    end;
    if status=1 then
    begin
      with dm.Qtemp do
      begin
        close;
        sql.Clear;
        sql.Text:='Update t_user set '+
                  ' user_name='+QuotedStr(EdNama.Text)+','+
                  ' full_name='+QuotedStr(Edfull_name.Text)+','+
                  ' Password='+QuotedStr(EdPass.Text)+','+
                  ' dept_code='+QuotedStr(kddept.Text)+','+
                  ' position_code='+QuotedStr(kdjab.Text)+''+
                  ' where code='+QuotedStr(EdNik.Text);
        ExecSQL;
      end;
    end;
    dm.koneksi.Commit;
    Messagedlg('Data Berhasil di Simpan',MtInformation,[Mbok],0);
    BBatalClick(sender);
    end
    Except
    on E :Exception do
    begin
    MessageDlg(E.Message,mtError,[MBok],0);
    dm.koneksi.Rollback;
    end;
    end;
end;

procedure TFNew_User.CbJabatanSelect(Sender: TObject);
begin
   with dm.Qtemp1 do
   begin
     close;
     sql.Clear;
     sql.Text:='select * from t_position where position='+Quotedstr(cbjabatan.Text)+' ';
     Open;
   end;
   kdjab.Text:=dm.Qtemp1.FieldByName('position_code').AsString;
end;

procedure TFNew_User.Clear;
begin
  EdNik.Clear;
  EdNama.Clear;
  Edfull_name.Clear;
  EdPass.Clear;
  CbJabatan.Text:='';
end;

procedure TFNew_User.EdDeptSelect(Sender: TObject);
begin
   with dm.Qtemp do
   begin
     close;
     sql.Clear;
     sql.Text:='select * from t_dept where dept='+Quotedstr(Eddept.Text)+' ';
     Open;
   end;
   kddept.Text:=dm.Qtemp.FieldByName('dept_code').AsString;
end;

procedure TFNew_User.FormShow(Sender: TObject);
begin
  Load;
end;

procedure TFNew_User.Load;
begin
  EdDept.Clear;
  with dm.Qtemp do
  begin
    close;
    sql.Clear;
    sql.Text:='Select * from t_dept';
    ExecSQL;
  end;
  Dm.Qtemp.First;
  while not Dm.Qtemp.Eof do
  begin
    EdDept.Items.Add(Dm.Qtemp['dept']);
    Dm.Qtemp.Next;
  end;

  CbJabatan.items.Clear;
  with dm.Qtemp do
  begin
    close;
    sql.Clear;
    sql.Text:='Select * from t_position';
    ExecSQL;
  end;
  Dm.Qtemp.First;
  while not Dm.Qtemp.Eof do
  begin
    CbJabatan.Items.Add(Dm.Qtemp['position']);
    Dm.Qtemp.Next;
  end;
end;


end.
